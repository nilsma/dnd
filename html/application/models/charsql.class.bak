<?php

require_once 'database.class.php';

if(!class_exists('Mysql')) {

  class Charsql extends Database {
    
    public function __construct() { }

    public function insertSheet($sheet, $attrs, $purse) {

      try {
	$mysqli = $this->connect();
	$mysqli->autocommit(FALSE);

	//begin insert attrs
	$query = 'INSERT INTO attrs(id, str, str_mod, con, con_mod, dex, dex_mod, intel, intel_mod, wis, wis_mod, cha, cha_mod) VALUES(null, ' . $attrs['str'] . ', ' . $attrs['strMod'] . ', ' . $attrs['con'] . ', ' . $attrs['conMod'] . ', ' . $attrs['dex'] . ', ' . $attrs['dexMod'] . ', ' . $attrs['intel'] . ', ' . $attrs['intelMod'] . ', ' . $attrs['wis'] . ', ' . $attrs['wisMod'] . ', ' . $attrs['cha'] . ', ' . $attrs['chaMod'] . ')';
	$result = $mysqli->query($query);
	if(!$result) {
	  $result->free();
	  throw new Exception($mysqli->error);
	}

	$attrs_id = $mysqli->insert_id;

	//begin insert purse
	$query = 'INSERT INTO purse(id, gold, silver, copper) VALUES(null, ' . $purse['gold'] . ', ' . $purse['silver'] . ', ' . $purse['copper'] . ')';
      	$result = $mysqli->query($query);
	if(!$result) {
	  $result->free();
	  throw new Exception($mysqli->error);
	}
	
	$purse_id = $mysqli->insert_id;

	//begin insert sheet
	$query = 'INSERT INTO sheet(id, owner, name, level, class, attr, purse, hp, dmg, init_roll, init_mod) VALUES(null, ' . $_SESSION['user_id'] . ', ' . $sheet['name'] . ', ' . $sheet['level'] . ', ' . $sheet['class'] . ', ' . $attrs_id . ', ' . $purse_id . ', ' . $sheet['hp'] . ', ' . $sheet['dmg'] . ', ' . $sheet['init_mod'] . ', ' . $sheet['init_roll'] .')';
	$result = $mysqli->query($query);
	if(!$result) {
	  $result->free();
	  throw new Exception($mysqli->error);
	}
	
	$mysqli->commit();
	$mysqli->autocommit(TRUE);

      }   

      catch(Exception $e) {
	$mysqli->rollback();
	$mysqli->autocommit(TRUE);
      }

      header('Location: ' . BASE . VIEWS . 'new-character.php');
    }

  }

}
?>