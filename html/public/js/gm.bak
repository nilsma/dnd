/**
 * A function to get the characters' details from the DB
 */
function getCharacters(callback) {
    var result = null;
    var obj = null;

    if (window.XMLHttpRequest) {
        xmlhttp=new XMLHttpRequest();
    } else {
        xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
    }

    xmlhttp.onreadystatechange=function() {
        if (xmlhttp.readyState==4 && xmlhttp.status==200) {
            result = xmlhttp.responseText;
	    obj = JSON.parse(result);
	    callback(obj);
        }
    }

    xmlhttp.open("POST", "../../../html/application/controllers/get-characters.php", true);
    xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    xmlhttp.send();
}

/**
 * A function to update the given members' section elements with the given characters' details
 */
function updateCharacters(ch, el) {
    for(var i = 0; i < el.length; i++) {
	document.getElementsByClassName('char_name')[i].innerHTML=ch[i]['sheet']['name'];
	document.getElementsByClassName('init_roll')[i].innerHTML=ch[i]['sheet']['init_roll'];
	document.getElementsByClassName('dmg')[i].innerHTML=ch[i]['sheet']['dmg'];
	document.getElementsByClassName('hitpoints')[i].innerHTML=ch[i]['sheet']['hp'];
	document.getElementsByClassName('level')[i].innerHTML=ch[i]['sheet']['level'];
	document.getElementsByClassName('class')[i].innerHTML=ch[i]['sheet']['class'];
	document.getElementsByClassName('xp')[i].innerHTML=ch[i]['sheet']['xp'];
	document.getElementsByClassName('str')[i].innerHTML=ch[i]['attrs']['str'];
	document.getElementsByClassName('str_mod')[i].innerHTML=ch[i]['attrs']['str_mod'];
	document.getElementsByClassName('con')[i].innerHTML=ch[i]['attrs']['con'];
	document.getElementsByClassName('con_mod')[i].innerHTML=ch[i]['attrs']['con_mod'];
	document.getElementsByClassName('dex')[i].innerHTML=ch[i]['attrs']['dex'];
	document.getElementsByClassName('dex_mod')[i].innerHTML=ch[i]['attrs']['dex_mod'];
	document.getElementsByClassName('intel')[i].innerHTML=ch[i]['attrs']['intel'];
	document.getElementsByClassName('intel_mod')[i].innerHTML=ch[i]['attrs']['intel_mod'];
	document.getElementsByClassName('wis')[i].innerHTML=ch[i]['attrs']['wis'];
	document.getElementsByClassName('wis_mod')[i].innerHTML=ch[i]['attrs']['wis_mod'];
	document.getElementsByClassName('cha')[i].innerHTML=ch[i]['attrs']['cha'];
	document.getElementsByClassName('cha_mod')[i].innerHTML=ch[i]['attrs']['cha_mod'];
	document.getElementsByClassName('gold')[i].innerHTML=ch[i]['purse']['gold'];
	document.getElementsByClassName('silver')[i].innerHTML=ch[i]['purse']['silver'];
	document.getElementsByClassName('copper')[i].innerHTML=ch[i]['purse']['copper'];
    }
}

/**
 * A function to get the members' section elements from the DOM
 */
function getMembers(callback) {
    var members = document.getElementsByClassName('member');
    callback(members);
}

/**
 * A function to get the members' section elements from the DOM
 * and to get the characters' details from the DB and subsequently
 * call the updateCharacters function
 */
function updateGm() {
    var elems;
    var chars;
    getMembers(function(result) {
	elems = result;
	getCharacters(function(chars) {
	    updateCharacters(chars, elems);
	});
    });
}

/**
 * A function to run the updateGm function periodically - every 3 seconds
 */
setInterval(
    function() {
	updateGm();
    }, 5000
);
